{% extends "base.html" %} {% block content %}
<div class="apartment-block">
  <h2>{{ apartment.title }}</h2>
  <img
    src="{{ url_for('static', path='images/default-image.jpg') }}"
    alt="Image"
  />
  <p><strong>Ціна:</strong> {{ apartment.price }} грн</p>
  <p class="description"><strong>Опис:</strong> {{ apartment.description }}</p>
  <p>
    <strong>Контактна особа:</strong> {{ owner.first_name }} {{ owner.last_name
    }}
  </p>
  <p><strong>Телефон:</strong> {{ owner.phone }}</p>
  <p>
    <strong>Адреса:</strong> {{ apartment.location.city }}, вул. {{
    apartment.location.street }}, буд. {{ apartment.location.house_number }}
  </p>

  {% if is_owner %}
  <form action="/apartments/{{ apartment.id }}/edit/" method="get">
    <button>Редагувати</button>
  </form>
  <form onsubmit="deleteApartment('{{ apartment.id }}'); return false;">
    <button>Видалити</button>
  </form>
  {% else %}
  
  {% if current_user %}
  <!-- Observation button -->
  {% if is_observed %}
  <button id="observeBtn" class="observed" onclick="toggleObservation('{{ apartment.id }}')">
    ★ В закладках
  </button>
  {% else %}
  <button id="observeBtn" onclick="toggleObservation('{{ apartment.id }}')">
    ☆ В закладки
  </button>
  {% endif %}
  {% endif %}

  <form action="">
    <button>Забронювати</button>
  </form>
  {% endif %}
</div>

<script>
  function deleteApartment(apartmentId) {
    if (confirm("Ви впевнені, що хочете видалити це оголошення?")) {
      fetch(`/apartments/${apartmentId}`, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
        },
        credentials: "same-origin", // Для збереження кукі
      })
        .then((response) => {
          if (response.ok) {
            window.location.href = "/";
          } else {
            alert("Щось пішло не так при видаленні.");
          }
        })
        .catch((error) => {
          alert("Помилка: " + error);
        });
    }
  }

  function toggleObservation(apartmentId) {
    const observeBtn = document.getElementById('observeBtn');
    const isObserved = observeBtn.classList.contains('observed');
    
    // Create headers
    const headers = {
      'Content-Type': 'application/json'
    };

    // If already observed, remove from observations
    if (isObserved) {
      fetch(`/apartments/${apartmentId}/observe`, {
        method: 'DELETE',
        headers: headers,
        credentials: 'same-origin'
      })
      .then(response => response.json())
      .then(data => {
        observeBtn.classList.remove('observed');
        observeBtn.textContent = '☆ В закладки';
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }
    // Otherwise, add to observations
    else {
      fetch(`/apartments/${apartmentId}/observe`, {
        method: 'POST',
        headers: headers,
        credentials: 'same-origin'
      })
      .then(response => response.json())
      .then(data => {
        observeBtn.classList.add('observed');
        observeBtn.textContent = '★ В закладках';
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }
  }
</script>

<style>
  button.observed {
    background-color: #ffc107;
    color: #000;
  }
</style>

{% endblock %}
